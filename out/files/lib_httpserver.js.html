<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib&#x2F;httpserver.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/Handler.html">Handler</a></li>
            
                <li><a href="..&#x2F;classes/Server.html">Server</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/knotter.html">knotter</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib&#x2F;httpserver.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;*
 * Knotter HttpServer
 * 
 * @author Patrice FERLET
 * @license GPLv3
 * @module knotter
 *&#x2F;

var http = require(&#x27;http&#x27;);
var path = require(&#x27;path&#x27;);
var mime = require(&#x27;mime&#x27;);
var fs   = require(&#x27;fs&#x27;);
var url  = require(&#x27;url&#x27;);
var _ = require(&#x27;underscore&#x27;);
var sessions = require(&#x27;sessions&#x27;);
var handler = require(&#x27;.&#x2F;handler&#x27;);
var qs = require(&#x27;querystring&#x27;);

&#x2F;**
 * Server is HTTP Server. To be used, prepare some handlers then
 * call constructor with options as:
 *
 * - handlers: Array of handlers
 * - statics: Array or Object to map some directory as static container
 * - port: to listen
 * - address: ...
 *
 * @class Server
 * @constructor
 * @param {Object} options (port, handlers, statics...)
 * @todo manage https
 * @example
 *
 *      var s = new knotter.Server({
 *          handlers: [hdl1, hdl2],
 *          statics: {&#x27;styles&#x27;: &#x27;css&#x2F;directory&#x2F;&#x27;},
 *          address : &#x27;0.0.0.0&#x27;,
 *          port    : 8080
 *      });
 *&#x2F;
var Server = function (options) {
    this.port = options[&#x27;port&#x27;] || 8000;
    this.address = options[&#x27;address&#x27;] || &quot;127.0.0.1&quot;;
    this.handlers = [];
    this.sessionHandler = new sessions();

    if (options[&#x27;handlers&#x27;] != undefined) {
        for (var i = 0; i &lt; options.handlers.length; i++) {
            this.addHandler(options.handlers[i]);
        }
    }
    if (options[&#x27;statics&#x27;] != undefined) {
        if (typeof(options[&quot;statics&quot;]) == &#x27;object&#x27; ){
            for (i in options.statics) {
                this._serveStatic(options.statics[i], i);
            }

        } else {
            for (i in options.statics) {
                this._serveStatic(options.statics[i]);
            }
        }
    }
};

&#x2F;**
 * Port to listen
 *
 * @property {int} port
 * @default 8000
 *&#x2F;
Server.prototype.port = 8000;


&#x2F;**
 * Address to listen
 *
 * @property {String} address
 * @default 127.0.0.1
 *&#x2F;
Server.prototype.address = &quot;127.0.0.1&quot;;

&#x2F;**
 * Session Handler, from &quot;sessions&quot; module
 *
 * @property {sessions.Session} sessionHandler
 *&#x2F;
Server.prototype.sessionHandler = null;


&#x2F;**
 * Handlers container, keep list of knotter.Handler.
 * To handler handlers, append them to constructor option and&#x2F;or
 * use addHandler method.
 *
 * @see Server.addHandler
 * @property {Array} handlers
 *
 *&#x2F;
Server.prototype.handlers = [];


&#x2F;**
 * Add handler to serve static files. 
 *
 *
 * @method _serveStatic
 * @private
 * @param {String} directory
 * @param {String} _route (optional, if not given, _route will match directory)
 *&#x2F;
Server.prototype._serveStatic = function (dir, _route){
    var route;
    if ( _route != undefined ) {
       route = _route;
    } else {
        dir = dir.replace(&#x2F;^\&#x2F;+&#x2F;,&#x27;&#x27;);
        dir = dir.replace(&#x2F;\&#x2F;+$&#x2F;,&#x27;&#x27;);
        route = dir;
    }

    var h = new handler.Handler({
        route: &#x27;^&#x2F;&#x27;+route+&#x27;&#x2F;(.*)&#x27;,
        get: function (){
            var filename =  path.join(path.resolve(this.directory),
                this.params.args[1]);

            try {
                fs.realpathSync(filename);   
                var mimetype = mime.lookup(filename);
                var self = this;
                fs.readFile(filename, function (err, data){
                    if (err) {
                        console.log(err);
                        self.response.writeHead(500);
                        self.response.end(&quot;Error 500&quot; + err);
                        return;
                    }

                    self.response.writeHead(200, {
                        &#x27;Content-Type&#x27; : mimetype,
                        &#x27;Content-Length&#x27; : data.length
                    });

                    self.response.end(data);
                });
            }
            catch(e){
                console.log(e);
                this.response.writeHead(404, &quot;Not found&quot;);
                this.response.end(&quot;404 Not found&quot;);
                return;
            }


        }
    });
    h.directory = dir;
    this.addHandler(h);
};

&#x2F;**
 * Add Handler in server registry
 *
 * @method addHandler
 * @param {knotter.Handler} handler
 *&#x2F;
Server.prototype.addHandler = function (handler){
    handler.__reg = new RegExp(handler.route);
    this.handlers.push(handler);
};


&#x2F;**
 * Called on each request to get handler mapped to
 * the called route
 *
 * @method handle
 * @protected
 * @param {http.Request} request
 * @param {http.Response} response
 *&#x2F;
Server.prototype.handle = function (req, res) {
    var query = url.parse(req.url);
    for (i in this.handlers) {
        var params = null;
        if ((params = query.pathname.match(this.handlers[i].__reg))) {
            var method = req.method.toLowerCase();
            &#x2F;&#x2F; to not interact on same request&#x2F;result while
            &#x2F;&#x2F; working on simulatneous connections
            var handler = _.clone(this.handlers[i]);
            if (handler[method]) {
                handler.response = res;
                handler.request = req;
                handler.params.args = params || [];
                handler.params.get  = query.query || {};

                if (method != &quot;get&quot;) {
                    &#x2F;&#x2F;should try to get post data
                    var body = &quot;&quot;;
                    var self = this;
                    req.on(&#x27;data&#x27;, function (data){
                       body += data;
                    });
                    req.on(&#x27;end&#x27;, function (){
                        handler.postdata = qs.parse(body);
                        if (handler.useSessions) {
                            this.sessionHandler.httpRequest(req, res, function (err, session){
                                handler.sessions = session;
                                handler[method]();
                            });
                        }
                        else {
                            handler[method]();
                        }
                    });
                } else {
                    &#x2F;&#x2F; GET cannot have some postdata, direct response
                    if (handler.useSessions) {
                        this.sessionHandler.httpRequest(req, res, function (err, session){
                            handler.sessions = session;
                            handler[method]();
                        });
                    }
                    else {
                        handler[method]();
                    }
                }
                return;
            }
        }
    }
    res.writeHead(404, &quot;Not found&quot;);
    res.end();
    return;
};


&#x2F;**
 * Start to serve http
 *
 * @method serve
 * @uses http.Server
 *&#x2F;
Server.prototype.serve = function () {
    var self = this;
    this.server = http.createServer(function (req, res){
        self.handle(req, res);
    });
    this.server.listen(this.port, this.address);
    console.log(&quot;Server listening on &quot;+this.address+&quot;:&quot;+this.port);
};


&#x2F;**
 * Alias to &#x60;serve&#x60; method
 *
 * @method start
 * @alias serve
 *&#x2F;
Server.prototype.start = function (){
    return this.serve();    
};


module.exports = {
        Server: Server
};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
